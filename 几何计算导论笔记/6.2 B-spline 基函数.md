# B样条基函数的定义

贝塞尔基函数用作控制点的权重，B样条基函数也是如此，但更复杂。B样条基函数有两个贝塞尔基函数所不具备的属性，即：（1）域被节点细分，（2）基函数在整个区间上不是非零的。事实上，每个 B 样条基函数在几个相邻子区间上是非零的，因此B 样条基函数非常“局部”。

令$U$为一组$m+1$个非递减数，$u_0\le u_1\le u_2\le ...\le u_m$。$u_i$被称为**节点**，集合$U$称为**节点向量**，半开区间$[u_i,u_{i+1})$称为**第 i 个节点区间**。注意，由于某些$u_i$可能是相等的，因此某些节点区间可能不存在。如果某一个节点 $u_i$ 出现 $k$ 次，即 $u_i=u_{i+1}=...=u_{i+k-1}$ ，其中$k>1$, 则$u_i$称为 **$k$ 重节点**，记为$u_i(k)$。如果$u_i$仅出现一次，则其是一个**简单节点**。如果节点之间是等间距的，即 $u_{i+1}-u_i$为0，$0\le i \le m-1$，则称节点向量是**均匀的**，否则是**不均匀的**。 

节点可以被看作是将整个区间$[u_0,u_m]$细分为若干节点区间的分割点，所有B样条基函数的域都应该在$[u_0,u_m]$上。在本笔记中，我们经常使用$u_0=0$和$u_m=1$，因此域是闭区间$[0,1]$。

为了定义B样条基函数我们还需要一个参数，即基函数的次数$p$。$p$次第$i$个基函数，记作$N_{i,p}$，其递归定义如下：

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis.jpg)

以上通常称为Cox-de Boor递归公式。这个定义看起来复杂，实则不难理解。如果次数为0，即$p=0$，这些基函数都是阶跃函数，这就是第一个表达式所表示的。也即是，如果$u$在第$i$个节点区间$[u_i,u_{i+1})$中，基函数$N_{i,0}(u)$为1。例如，如果我们有四个节点$u_0=0、u_1=1、u_2=2$和$u_3=3$，则节点区间0，1和2为$[0,1),[1,2),[2,3)$，0次基函数在$[0,1)$是$N_{0,0}(u)=1$，在其他区间为0。类似地，在$[1,2)$区间上$N_{1,0}(u)=1$，其它区间为0，以及在$[2,3)$区间上$N_{2,0}=1$，其它处则为0。正如下图所见：

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis-0.jpg)

为了理解$p$大于0时计算$N_{i,p}(u)$的方式，我么使用三角计算模式。所有节点区间都列在左（第一）列，所有0次及基函数在第二列，如下图所示：

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-scheme.jpg)

要计算$N_{i,1}(u)$，需要$N_{i,0}(u)$和$N_{i+1,0}(u)$。因此，我们还需计算$N_{0,1}(u)、N_{1,1}(u)、N_{2,1}(u)、N_{3,1}(u)$等，所有这些$N_{i,1}(u)都在第三列$。计算完所有这些$N_{i,1}(u)$，我们还需要计算$N_{i,2}(u)$，并将其放在第六列。这个过程一直持续到计算出所有需要的$N_{i,p}(u)$。

如上述，我们得到了节点向量$U={0,1,2,3}$ 的 $N_{0,0}(u),N_{1,0}(u)$和$N_{2,0}(u)$。现在我们开始计算$N_{0,1}(u)$和$N_{1,1}(u)$，为了计算$N_{0,1}(u)$，因为$i=0,p=1$，从定义中我们得到

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis-example-1-1.jpg)

因为$u_0=1,u_1=1$和$u_2=2$，上式变为

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis-example-1-2.jpg)

由于$N_{0,0}(u)$在$[0,1)$上非0，且$N_{1,0}(u)$在$[1,2)$上非0，如果$u$在$[0,1)$（或者$[1,2)$）上，仅有$N_{0,0}(u)$（或者$N_{1,0}(u)$）为$N_{0,1}(u)$贡献。因此，如果$u$在$[0,1)$上，$N_{0,1}(u)$为$uN_{0,0}(u)=u$；如果$u$在$[1,2)$上，$N_{0,1}(u)$为$（2-u）N_{1,0}(u)=2-u$。类似地，当$u$在$[1,2)区间，$$N_{1,1}(u)=u-1$，当$u$在$[2,3)区间，$$N_{1,1}(u)=3-u$。在下图中，黑色和红色线分别是$N_{0,1}(u)$和$N_{1,1}(u)$。注意$N_{0,1}(u)$在$[0,1)$和$[1,2)$上非0，对应的$N_{1,1}(u)$在$[1,2)$和$[2,3)$上非0。

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-ex-1-d1.jpg)

当得到$N_{0,1}(u)$和$N_{1,1}(u)$，我们可以计算$N_{0,2}(u)$。由定义

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis-example-1-3.jpg)

将节点值代入得到

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis-example-1-4.jpg)

注意$N_{0,1}(u)$在$[0,1)$和$[1,2)$上非0，对应的$N_{1,1}(u)$在$[1,2)$和$[2,3)$上非0。因此，这里存在三种情况需要考虑:

1. $u$在$[0,1)$上

   该情况下，仅$N_{0,1}(u)$给$N_{0,2}(u)$贡献，因为$N_{0,1}(u)$为$u$，我们得到：

   ![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis-example-1-5.jpg)

2. $u$在$[1,2)$上

   该情况下，$N_{0,1}(u)$和$N_{1,1}(u)$都会给$N_{0,2}(u)$贡献，因为在$[1,2)$$N_{0,1}(u)=2-u$，且$N_{1,1}(u)=u-1$，我们得到：

   ![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis-example-1-6.jpg)

3. $u$在$[2,3)$上

   该情况下，仅$N_{1,1}(u)$给$N_{0,2}(u)$贡献，因为$N_{1,1}(u)$在$[2,3)$为$3-u$，我们得到：

​	![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis-example-1-7.jpg)

如果我们画出上述三种情况的曲线段，我们会看到两条相邻的曲线段在节点处连接在一起形成一条曲线。更准确地说，第一种和第二种情况的曲线段在$u-1$处连接在一起，而第二种和第三种情况的曲线段在 $u-2$处连接。请注意，这里显示的复合曲线是平滑的。但一般来说，如果一个节点向量包含多个节点，情况并非总是如此。

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-ex-1-d2.jpg)

----

由于$N_{i,1}(u)$是由$N_{i,0}(u)$和$N_{i+1,0}(u)$定义，而且$N_{i,0}(u)$和$N_{i+1,0}(u)$分别在区间$[u_i,u_{i+1})、[u_{i+1},u_{i+2})$上非0，则$N_{i,1}(u)$在$[u_i,u_{i+2})$非0。类似地，由于$N_{i,2}(u)$是由$N_{i,1}(u)$和$N_{i+1,1}(u)$定义，而且$N_{i,1}(u)$和$N_{i+1,1}(u)$分别在区间$[u_i,u_{i+2})、[u_{i+1},u_{i+3})$上非0，则$N_{i,2}(u)$在$[u_i,u_{i+3})$非0。一般地，要确定基函数$N_{i,p}(u)$的非0区间，可以使用三角计算模式回溯，直到到达第一列。覆盖的区域是这个基函数的非零域。由上可知，我们可以在左上和左下方向回溯，直达第一列，如下图蓝色虚线示。因此，$N_{1,3}(u)$在$[u_1,u_2)、[u_2,u_3)、[u_3,u_4)$和$[u_4,u_5)$上非0。换言之，它在$[u_1,u_5)$上非0。

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-back.jpg)

总而言之，我们有如下观察：

<font color="red">基函数$N_{i,p}(u)$在$[u_i,u_{i+p+1})$上非0，或者说$N_{i,p}(u)$在$p+1$个节点区间非0，该$k+1$节点区间为$[u_i,u_{i+1})、[u_{i+1},u_{i+2})、...[u_{i+p},u_{i+p+1})$。</font>

接下来，我们逆过来看。给定一个节点区间$[u_i,u_{i+1})$，我们想要知道哪些基函数会在计算中使用该节点区间。我们可以从这个节点区间开始，画一条右上角和右下角的箭头，形成一个楔型区域，包含在这个楔型中的所有基函数都使用$N_{i,0}(u)$，因此在这个区间上是非0的。因此，所有在$[u_i,u_{i+1})$上非0的$p$次基函数是该楔型与包含所有的$N_{i,p}(u)$的列交集。事实上，从$N_{i,0}(u)$到$N_{i,p}(u)$有$p+1$列。因此，等边三角形的垂直边必须最多有$p+1$条目，即$N_{i,p}(u), N_{i-1,p}(u), N_{i-2,p}(u), ..., N_{i- p+2,p}(u)、N_{i-p+1,p}(u) 和 N_{i-p,p}(u)。$

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-non-0.jpg)

观察上面图表，欲找到所有在$[u_4,u_5)$上非0的3次基函数我们仅需要从第一列$[u_4,u_5)$出发，绘制两条箭头分别向右上角和右下角，在第五列的垂直边缘上的所有基函数即是我们想要的，即$N_{1,3}(u)、N_{2,3}(u)、N_{3,3}(u)$和$N_{4,3}(u)$。类似地，我们可以观察到在$[u_2,u_3)$区间上非0的三次基函数为$N_{0,3}(u)、N_{1,3}(u)$和$N_{2,3}(u)$。

总而言之，我们有如下观察：

<font color="red">在任意节点区间$[u_i,u_{i+1})$上，至多有$p+1$个$p$次基函数是非0的，即$N_{i-p,p}(u)、N_{i-p+1,p}(u)、N_{i-p+2,p}(u)$以及和$N_{i,p}(u)$。</font>

### 基函数的系数究竟是什么意思?

最后我们一起讨论一下基函数$N_{i,p}(u)$的系数究竟是什么意思？代表了什么？我们知道，如果要计算$N_{i,p}(u)$，我们首先需要计算出$N_{i,p-1}(u)$和$N_{i+1,p-1}(u)$。前者在$[u_i,u_{i+p})$上非0，如果u在此半开区间上，则$u-u_i$是$u$和该区间左端点$u_i$之间的距离，此区间的区间长度为$u_{i+p}-u_i$，则$(u-u_i)/(u_{i+p}-u_i)$表示这两端长度的比例，如下图所示，该值在0和1之间。类似地，后者在$[u_{i+1},u_{i+p+1})$上非0，如果u在此半开区间上，则$u_{i+p+1}-u$是$u$和该区间右端点$u_{i+p+1}$之间的距离，此区间的区间长度为$u_{i+p+1}-u_{i+1}$，则$(u_{i+p+1}-u)/(u_{i+p+1}-u_{i+1})$表示这两段长度之比，该值在0和1之间。

因此，$N_{i,p}(u)$是$N_{i,p-}(u)$和$N_{i+1,p-1}(u)$的线性组合，具有两个系数，均与$u$呈线性关系，范围在0与1之间。

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/division-of-u.jpg)

# B样条基函数的重要性质

回忆一下B样条基函数的定义，如下图示：

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis.jpg)

该基函数具有以下性质，其中许多类似与贝塞尔基函数的性质：

1. **$N_{i,p}(u)$是第$i$个$p$次基函数在自变量为$u$时的值**；
2. **非负性**。对于所有的$i,\, p,\, u$，$N_{i,p}(u)$总是非负的；
3. **局部性**。$N_{i,p}(u)$是$[u_i,u_{i+p+1})$上的非0多项式。
4. **在任意节点区间$[u_i,u_{i+1})$上，之多$p+1$个$p$次基函数非0**，即$N_{i-p,p}(u)、N_{i-p+1,p}(u)、N_{i-p+2,p}(u)$以及和$N_{i,p}(u)$。
5. **完整性**。节点区间$[u_i,u_{i+1})$上所有非0次$p$基函数的总和为1。前面的性质表明 $N_{i-p,p}(u), N_{i-p+1,p}(u), N_{i-p+2,p}(u), ...,$ 和 $N_{i,p}(u) $是非$[u_i, u_{i+1})$ 上的零。这表明这些 $p+1$ 基函数的总和为 1。
6. **如果节点数为$m+1$，基函数的次数为$p$，$p$次基函数的数量为$n+1$，则$m=n+p+1$。**
7. **基函数$N_{i,p}(u)$是在$[u_i,u_{i+p+1})$中节点处连接点的$p$次多项式的复合节点**。上一页显示的示例很好地说明了此属性。例如，在 [0,3) 上为非零的 $N_{0,2}(u)$ 由定义在 [0,1)、[1,2) 和 [2,3) 上的三个抛物线构成。它们在结 2 和 3 处连接在一起。
8. **在$k$重节点处，基函数$N_{i,p}(u)$是$C^{p-k}$连续**。因此，增加多重性会降低连续性水平，而增加度数会增加连续性。上述二阶基函数 $N_{0,2}(u)$ 在节点 2 和 3 处是 $C^1$ 连续的，因为它们是简单节点 $(k = 1)$。

### 多重节点的影响

多重节点确实会对基函数的计算和一些“计数”性质有很大影响，接下来我们将讨论其中两个。

1. 每个$k$重基函数最多减少$k-1$个基函数非0区间。

   考虑 $N_{i,p}(u)$ 和 $N_{i+1,p}(u)$。前者在 $[u_i, u_{i+p+1})$ 上非零，而后者在 $[u_{i+1}, u_{i+p+2}) $上非零。如果我们将 $u_{i+p+2}$ 移动到 $u_{i+p+1}$ 使它们成为一个双结。那么，$N_{i,p}(u)$ 仍然有 $p+1$ 个节点跨度，在该节点跨度上它是非零的；但是，由于跨度 $[u_{i+p+1},u_{i+p+2})$ 消失，$N_{i+1,p}(u)$ 为非零的节点跨度数减少了 1。

   其实这还是很容易理解的，事实上，我们忽略改变节点区间的端点，<font color="red">为了创建一个$k$重节点，$k-1$个基函数受到了影响。其中一个基函数失去了一个节点区间，二分之一的基函数失去了两个，三分之一的基函数失去了三个基函数，以此类推。</font>

   下图a展示了5次基函数，其中左端点和右端点的重数为6，中间都是简单节点。图b是将$u_5$移动到$u_6$的结果。以$u_6$结尾的基函数具有的非0节点区间变少了。接下来如图c、d所见，分别将$u_4、u_3$移动到$u_6$，使得$u_6$变成了4重节点，图e将$u_2$移动到$u_6$，使得$u_6$变成了5重节点。

   <img src="/home/balaa/Pictures/typora/image-20220909151225670.png" alt="image-20220909151225670" style="zoom:70%;" />

2. 每个$k$重内部节点，其非零基函数的个数至多为$p-k+1$。

   由于将 $u_{i-1}$ 移动到 $u_i$ 会使得以 $u_{i-1}$ 结尾的非0基函数变成以 $u_i$ 结尾的基函数，这将 $u_i$ 处的非零基函数的数量减少了 1。更准确地说，将 $u_i$ 的重数增加1将使非零基函数的数量减少1。由于在 $u_i$ 处最多有 $p+1$ 个基函数可以是非零的，因此重数 k 的节点处的非零基函数的数量最多为 $(p + 1) - k = p - k + 1$。

   在上图中，由于节点 $u_6$ 的重数为 1（简单）、2、3、4 和 5，因此 $u_6$ 处的非零基函数个数为 5、4、3、2 和 1。

# B样条基函数计算示例

### 简单节点

假设节点向量为$U=\{0,0.25,0.5,0.75,1\}$，因此$m=4,u_0=0,u_1=0.25,u_2=0.5,u_3=0.75,u_4=1$。0次基函数非常简单，它们是$N_{0,0}(u)、N_{1,0}(u)、N_{2,0}(u)、N_{3,0}(u)$分别定义在节点区间$[0,0.25,), [0.25,0.5), [0.5,0.75) $和$[0.75,1)$上，对应的如下图所见：

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-ex-2-d0.jpg)

下表给出了$N_{i,1}(u)$的结果

<img src="/home/balaa/Pictures/typora/image-20220909152946441.png" alt="image-20220909152946441" style="zoom:80%;" />

下图是这些基函数的图像，由于内部节点0.25，0.5，0.75都是简单节点，且当$p=1$时存在$p-k+1=1$个非0基函数和三个节点。此外，$N_{0,1}(u)、N_{1,1}(u)$ 和 $N_{2,1}(u)$ 在节点 0.25、0.5 和 0.75 处分别是 $C^0$ 连续的

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-ex-2-d1.jpg)

从$N_{i,1}(u)$中我们可以得到2次基函数，因为$m=4,p=2,m=n+p+1$，我们可以计算得到$n=1$，也即仅存在两个2次基函数$N_{0,2}(u)$和$N_{1,2}(u)$，如下表示：

<img src="/home/balaa/Pictures/typora/image-20220909153603591.png" alt="image-20220909153603591" style="zoom:80%;" />

下图展示了两个基函数的图像，图中蓝色竖直线表示节点位置，注意每个基函数曲线都是有三个2次基函数曲线组合得到的。例如，基函数$N_{0,2}(u)$是绿色曲线，其由定义在$[0,0.25)、[0.25,0.5)、[0.5,0.75)$三条1次基函数曲线组合得到，这三条曲线联合在一起形成了绿色的钟型曲线。

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-ex-2-d2.jpg)

### 正多重节点

如果节点向量包含正多重节点，在计算基函数的系数时候我们将会遇到$0/0$问题，此处定义$0/0=0$。幸运的是，在计算中，如果存在多重节点如$u_i = u_{i+1} = ... = u_{i+k-1}$，我们可以非常高效地将$N_{i,0}(u)、N_{i+1,0}(u)、...、N_{i+k-1,0}(u)$直接设置为0。

考虑一个节点向量$U=\{0,0,0,0.3,0.5,0.5,0.6,1,1,1\}$，其中0，1都是3重节点，0.5是2重节点，$m=9$，如下

![image-20220909155656661](/home/balaa/Pictures/typora/image-20220909155656661.png)

我们可以计算$N_{i,0}(u)$，注意$m=9,p=0$我们知道$n=m-p-1=8$，正如下表所示，0次仅有4个非0基函数，分别是$N_{2,0}(u)、N_{3,0}(u)、N_{5,0}(u)、N_{6,0}(u)$。

<img src="/home/balaa/Pictures/typora/image-20220909155743121.png" alt="image-20220909155743121" style="zoom:80%;" />

然后我们计算1次基函数，由于$p=1,n=m-p-1=7$，下表显示该结果：

<img src="/home/balaa/Pictures/typora/image-20220909155720592.png" alt="image-20220909155720592" style="zoom:80%;" />

下图显示这些基函数图像

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-ex-3-d1.jpg)

我们一起来观察一下$N_{1,1}(u)$的计算，

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis-example-2-1.jpg)

我们将$u_1=u_2=0,u_3=0.3$代入该方程得

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis-example-2-2.jpg)

因为$N_{1,0}(u)$处处为0，第一项的系数出现了$0/0$问题，所幸我们定义其为0，因此仅有第二项影响该结果。所以在[0,0.3)上$N_{1,1}(u)=1-(10/3)u$。

接下来我们再计算$N_{i,2}(u)$，因为$p=2,n=m-p-1=6$，下表显示该结果：

<img src="/home/balaa/Pictures/typora/image-20220909160427036.png" alt="image-20220909160427036" style="zoom:80%;" />

下图展示了2次基函数的图像

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-ex-3-d2.jpg)

我们一起观察一下$N_{3,2}(u)$的计算

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis-example-2-3.jpg)

将$u_3=0.3,u_4=u_5=0.5,u_6=0.6$代入得

![img](https://pages.mtu.edu/~shene/COURSES/cs3621/NOTES/spline/B-spline/bs-basis-example-2-4.jpg)

因为$N_{3,1}(u)$是在$[0.3,0.5)$上的非0基函数，且等于$5u-1.5$，则在该区间上$(5u-1.5)^2$是$N_{3,2}(u)$的非0部分。

因为$N_{4,1}(u)$是在$[0.5,0.6)$上的非0基函数，且等于$6-10u$，则在该区间上$(6-10u)^2$是$N_{3,2}(u)$的非0部分。

我们再来研究一下节点$0.5$处的连续性问题。由于其重数为 2 且这些基函数的次数为 2，因此基函数 $N_{3,2}(u)$ 在 0.5 处是 $C^0$ 连续的，这就是$N_{3,2}(u)$ 在 0.5 处具有锐角的原因。对于不在两端的节点，如 0.3，因其为简单节点，所以保持 $C^1$ 连续性。